<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Notas de Voz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilo adicional para feedback visual */
        .upload-area {
            border: 2px dashed #cbd5e1; /* slate-300 */
            transition: border-color 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        #spinner { display: none; }
        #download-link-container { display: none; }
        #error-message { display: none; }
        #status-message { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen flex items-center justify-center font-sans p-4">

    <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
        <h1 class="text-3xl font-bold text-center text-slate-800 mb-6">üéôÔ∏è Analisador de Notas de Voz</h1>
        <p class="text-slate-600 text-center mb-8">Grave diretamente ou fa√ßa upload de sua nota de voz para obter uma transcri√ß√£o, resumo e pr√≥ximos passos acion√°veis.</p>

        <div class="flex justify-center gap-4 mb-6">
            <button type="button" id="record-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic mr-2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                Gravar √Åudio
            </button>
            <button type="button" id="stop-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out flex items-center hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square mr-2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>
                Parar Grava√ß√£o
            </button>
        </div>

        <div id="recording-status" class="text-center text-slate-600 mb-4 hidden">
            <span id="recording-timer">00:00</span> - Gravando...
        </div>

        <form id="upload-form" enctype="multipart/form-data" class="hidden">
            <div id="upload-area" class="upload-area rounded-lg p-10 text-center cursor-pointer hover:border-slate-400">
                <input type="file" id="audio-file" name="audio_file" accept=".wav, .mp3" class="hidden">
                <div class="flex flex-col items-center">
                     <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload-cloud text-slate-500 mb-4"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                    <p class="text-slate-700 font-medium">Arraste e solte seu arquivo aqui</p>
                    <p class="text-slate-500 text-sm mt-1">ou</p>
                    <button type="button" id="browse-button" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out">
                        Selecione o Arquivo
                    </button>
                    <p class="text-xs text-slate-400 mt-4">Formatos suportados: WAV, MP3. Tamanho m√°ximo: 25MB.</p>
                </div>
            </div>
            <div id="file-name-display" class="text-center text-slate-600 mt-4 h-6"></div>
             <button type="submit" id="submit-button" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="button-text">Analisar √Åudio</span>
            </button>
        </form>

        <div id="status-message" class="mt-6 p-4 bg-blue-100 text-blue-800 rounded-lg text-center"></div>
        <div id="error-message" class="mt-6 p-4 bg-red-100 text-red-800 rounded-lg text-center"></div>

        <div id="download-link-container" class="mt-6 text-center">
            <p class="text-slate-700 mb-2">Seu relat√≥rio est√° pronto!</p>
            <a id="download-link" href="#" download="analise_nota_voz.md" class="inline-flex items-center bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Baixar Relat√≥rio (.md)
            </a>
            <p class="text-xs text-slate-500 mt-2">O link expira em <span id="timer">15:00</span> minutos.</p>
        </div>

        <p class="text-xs text-slate-400 text-center mt-8">Desenvolvido com ‚ù§Ô∏è e IA</p>
    </div>

        <script>
        // Vari√°veis globais para controle da grava√ß√£o
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let timerInterval;

        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('audio-file');
        const browseButton = document.getElementById('browse-button');
        const uploadForm = document.getElementById('upload-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const fileNameDisplay = document.getElementById('file-name-display');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const downloadLinkContainer = document.getElementById('download-link-container');
        const downloadLink = document.getElementById('download-link');
        const timerDisplay = document.getElementById('timer');

        let analysisTaskId = null; // Para guardar o ID da tarefa no backend
        let downloadTimerInterval = null;
        const MAX_FILE_SIZE_MB = 25;
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

        // --- Fun√ß√µes Auxiliares ---
        function showStatus(message) {
            errorMessage.style.display = 'none';
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            downloadLinkContainer.style.display = 'none';
        }

        function showError(message) {
            statusMessage.style.display = 'none';
            errorMessage.textContent = `Erro: ${message}`;
            errorMessage.style.display = 'block';
            downloadLinkContainer.style.display = 'none';
            resetUI();
        }

        function showDownloadLink(url, durationSeconds) {
            statusMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            downloadLink.href = url;
            downloadLinkContainer.style.display = 'block';
            startDownloadTimer(durationSeconds);
            resetUI(); // Reseta o bot√£o de submit
        }

         function resetUI() {
            submitButton.disabled = true; // Desabilita por padr√£o at√© um arquivo ser selecionado
            spinner.style.display = 'none';
            buttonText.textContent = 'Analisar √Åudio';
            fileInput.value = ''; // Limpa o input de arquivo
            fileNameDisplay.textContent = '';
            uploadArea.classList.remove('dragover'); // Garante que o estilo de dragover seja removido
        }

        function startDownloadTimer(duration) {
            clearInterval(downloadTimerInterval); // Limpa timer anterior
            let timer = duration;
            let minutes, seconds;
            downloadTimerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                timerDisplay.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(downloadTimerInterval);
                    downloadLinkContainer.style.display = 'none'; // Esconde o link
                    showStatus('O link de download expirou.');
                }
            }, 1000);
        }

        function handleFileSelect(file) {
            if (!file) return;

             // Valida√ß√£o do tipo de arquivo
            if (!['audio/wav', 'audio/mpeg', 'audio/mp3'].includes(file.type)) {
                showError('Formato de arquivo inv√°lido. Use WAV ou MP3.');
                resetUI();
                return;
            }

             // Valida√ß√£o do tamanho do arquivo
            if (file.size > MAX_FILE_SIZE_BYTES) {
                showError(`Arquivo muito grande. O tamanho m√°ximo √© ${MAX_FILE_SIZE_MB}MB.`);
                resetUI();
                return;
            }

            fileNameDisplay.textContent = `Arquivo selecionado: ${file.name}`;
            submitButton.disabled = false; // Habilita o bot√£o de submit
            // Limpa mensagens anteriores
            statusMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            downloadLinkContainer.style.display = 'none';
        }

        // --- Fun√ß√µes de Grava√ß√£o ---
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    clearInterval(timerInterval);
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    await handleRecordedAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start(100); // Coleta chunks a cada 100ms
                recordingStartTime = Date.now();
                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
                
                // Atualiza UI
                document.getElementById('record-button').classList.add('hidden');
                document.getElementById('stop-button').classList.remove('hidden');
                document.getElementById('recording-status').classList.remove('hidden');
                document.getElementById('upload-form').classList.add('hidden');
                
            } catch (error) {
                console.error('Erro ao acessar microfone:', error);
                showError('N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recording-timer').textContent = `${minutes}:${seconds}`;
        }

        async function handleRecordedAudio(audioBlob) {
            try {
                showStatus('Preparando grava√ß√£o...');
                
                const formData = new FormData();
                formData.append('audio_blob', audioBlob, 'recording.webm');
                
                // Reutiliza a l√≥gica de upload existente
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json().catch(() => ({ detail: 'Erro desconhecido no servidor.' }));
                    throw new Error(errorData.detail || `Erro ${uploadResponse.status}`);
                }

                const uploadResult = await uploadResponse.json();
                analysisTaskId = uploadResult.task_id;
                checkAnalysisStatus();

            } catch (error) {
                console.error('Erro ao enviar grava√ß√£o:', error);
                showError(error.message || 'Falha no envio da grava√ß√£o.');
                resetRecordingUI();
            }
        }

        function resetRecordingUI() {
            document.getElementById('record-button').classList.remove('hidden');
            document.getElementById('stop-button').classList.add('hidden');
            document.getElementById('recording-status').classList.add('hidden');
            document.getElementById('upload-form').classList.remove('hidden');
            clearInterval(timerInterval);
        }

        // --- Event Listeners ---
        document.getElementById('record-button').addEventListener('click', startRecording);
        document.getElementById('stop-button').addEventListener('click', stopRecording);
        browseButton.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (event) => {
            handleFileSelect(event.target.files[0]);
        });

        // Drag and Drop
        uploadArea.addEventListener('dragover', (event) => {
            event.preventDefault(); // Necess√°rio para permitir o drop
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (event) => {
            event.preventDefault(); // Impede o navegador de abrir o arquivo
            uploadArea.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            fileInput.files = event.dataTransfer.files; // Atualiza o input
            handleFileSelect(file);
        });

        // Upload ao clicar na √°rea (al√©m do bot√£o)
        uploadArea.addEventListener('click', (event) => {
            // Evita acionar o clique se o clique foi no bot√£o interno
            if (event.target !== browseButton && !browseButton.contains(event.target)) {
                 fileInput.click();
            }
        });


        // Submit do Formul√°rio
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                showError('Nenhum arquivo selecionado.');
                return;
            }

            submitButton.disabled = true;
            spinner.style.display = 'inline-block';
            buttonText.textContent = 'Enviando...';
            statusMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            downloadLinkContainer.style.display = 'none';


            const formData = new FormData();
            formData.append('audio_file', file);

            try {
                // 1. Enviar arquivo para o backend
                const uploadResponse = await fetch('/upload', { // Endpoint do Flask
                    method: 'POST',
                    body: formData,
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json().catch(() => ({ detail: 'Erro desconhecido no servidor.' }));
                    throw new Error(errorData.detail || `Erro ${uploadResponse.status}`);
                }

                const uploadResult = await uploadResponse.json();
                analysisTaskId = uploadResult.task_id; // Guarda o ID da tarefa

                // 2. Iniciar verifica√ß√£o do status
                buttonText.textContent = 'Processando...';
                showStatus('√Åudio enviado. Transcrevendo e analisando...');
                checkAnalysisStatus();

            } catch (error) {
                console.error('Upload error:', error);
                showError(error.message || 'Falha no upload do arquivo.');
                resetUI();
                // Reabilita o bot√£o apenas se um arquivo ainda estiver selecionado
                if (fileInput.files.length > 0) {
                    submitButton.disabled = false;
                }
            }
        });

        // Fun√ß√£o para verificar o status da an√°lise periodicamente
        function checkAnalysisStatus() {
            if (!analysisTaskId) return;

            const intervalId = setInterval(async () => {
                try {
                    const statusResponse = await fetch(`/status/${analysisTaskId}`); // Endpoint do Flask

                    if (!statusResponse.ok) {
                        // Se o status for 404, a tarefa pode n√£o existir mais ou ID errado
                         if (statusResponse.status === 404) {
                             clearInterval(intervalId);
                             showError('Tarefa de an√°lise n√£o encontrada ou expirada.');
                             resetUI();
                             return;
                         }
                        // Outros erros de servidor
                        throw new Error(`Erro ao verificar status: ${statusResponse.status}`);
                    }

                    const statusResult = await statusResponse.json();

                    if (statusResult.status === 'completed') {
                        clearInterval(intervalId);
                        showDownloadLink(statusResult.download_url, statusResult.expires_in);
                        analysisTaskId = null; // Limpa o ID da tarefa
                    } else if (statusResult.status === 'failed') {
                        clearInterval(intervalId);
                        showError(statusResult.error || 'Falha no processamento do √°udio.');
                        analysisTaskId = null; // Limpa o ID da tarefa
                        resetUI();
                    } else {
                        // Continua processando, atualiza a mensagem se necess√°rio
                        showStatus(statusResult.message || 'Processando...');
                        buttonText.textContent = 'Processando...'; // Mant√©m o bot√£o indicando trabalho
                    }

                } catch (error) {
                    console.error('Status check error:', error);
                    // Decide se para de verificar ou tenta novamente
                    // Poderia parar ap√≥s X tentativas falhas
                    // Por simplicidade, vamos parar em qualquer erro de rede/fetch
                    clearInterval(intervalId);
                    showError('Erro de comunica√ß√£o ao verificar o status da an√°lise.');
                    resetUI();
                    analysisTaskId = null;
                }
            }, 3000); // Verifica a cada 3 segundos
        }

         // Inicializa a UI no carregamento
         resetUI();

    </script>
</body>
</html>
